#!/bin/bash
# Note: set -e is not used here as it doesn't work well with background jobs
# Errors will be caught by checking wait's exit status

help () {
    cat<<EOF

Usage: converttoaiff [convert|help]

Commands:

    converttoaiff   use bash command to generate audio files from text
                    Processes all files in parallel for faster execution

    Open Terminal.App (for Mac)
    Navigate to the folder where this file is located
    type into the command line "./converttoaiff convert" without quotes
    Enter Password
    Wait...
    help       print this msg

EOF
}

# Detect OS and set TTS command
detect_tts_command() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        TTS_CMD="say"
        TTS_OUTPUT_FLAG="-o"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux - prefer espeak over spd-say for file output support
        if command -v espeak &> /dev/null; then
            TTS_CMD="espeak"
            TTS_OUTPUT_FLAG="-w"
        elif command -v spd-say &> /dev/null; then
            echo "Warning: spd-say doesn't support file output. Please install espeak instead."
            echo "Install with: sudo apt-get install espeak"
            exit 1
        else
            echo "Error: No TTS tool found. Please install espeak."
            echo "Install with: sudo apt-get install espeak"
            exit 1
        fi
    else
        echo "Unsupported OS: $OSTYPE"
        exit 1
    fi
    
    echo "Using TTS command: $TTS_CMD"
}

# Detect OS and set audio conversion command
detect_convert_command() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS - use afconvert
        CONVERT_CMD="afconvert -d 'aac ' -f 'mp4f'"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux - use ffmpeg
        if command -v ffmpeg &> /dev/null; then
            CONVERT_CMD="ffmpeg -i"
            CONVERT_OPTS="-c:a aac -b:a 128k -y"
        else
            echo "Error: ffmpeg not found. Please install ffmpeg."
            exit 1
        fi
    else
        echo "Unsupported OS: $OSTYPE"
        exit 1
    fi
    
    echo "Using audio conversion command: $CONVERT_CMD"
}

# Convert a single file (to be run in background)
convert_file() {
    local input_pattern="$1"
    local output_name="$2"
    
    echo "Creating ${output_name}.aiff audio file..."
    
    # Generate TTS audio
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS: say reads from stdin
        cat ${input_pattern} | $TTS_CMD $TTS_OUTPUT_FLAG ${output_name}.aiff
    else
        # Linux: espeak reads from file, use process substitution
        $TTS_CMD -f <(cat ${input_pattern}) $TTS_OUTPUT_FLAG ${output_name}.aiff
    fi
    
    # Convert to m4a format
    if [[ "$OSTYPE" == "darwin"* ]]; then
        afconvert -d 'aac ' -f 'mp4f' ${output_name}.aiff
    else
        # Linux uses ffmpeg to convert WAV to m4a
        ffmpeg -i ${output_name}.aiff -c:a aac -b:a 128k -y ${output_name}.m4a 2>/dev/null
    fi
    
    echo "Completed ${output_name}"
}

convert () {
    # Detect TTS and conversion commands at runtime
    detect_tts_command
    detect_convert_command

    echo '========================================='
    echo 'Starting parallel audio file conversion!'
    echo 'Processing all files simultaneously for faster execution.'
    echo 'Please be patient - this will be much faster than before!'
    echo '========================================='
    echo ''

    # Launch all conversion jobs in parallel (background)
    convert_file "intro_p*.txt" "introduction" &
    convert_file "tablet1_p*.txt" "tablet1" &
    convert_file "tablet2_p*.txt" "tablet2" &
    convert_file "tablet3_p*.txt" "tablet3" &
    convert_file "tablet4_p*.txt" "tablet4" &
    convert_file "tablet5_p*.txt" "tablet5" &
    convert_file "tablet6_p*.txt" "tablet6" &
    convert_file "tablet7_p*.txt" "tablet7" &
    convert_file "tablet8_p*.txt" "tablet8" &
    convert_file "tablet9_p*.txt" "tablet9" &
    convert_file "tablet10_p*.txt" "tablet10" &
    convert_file "tablet11_p*.txt" "tablet11" &
    convert_file "tablet12_p*.txt" "tablet12" &
    convert_file "tablet13_p*.txt" "tablet13" &
    convert_file "tablet14_p*.txt" "tablet14" &
    convert_file "glossary_p*.txt" "glossary" &

    # Wait for all background jobs to complete
    echo ''
    echo 'Waiting for all conversion jobs to complete...'
    if wait; then
        echo ''
        echo '========================================='
        echo 'All audio files generated successfully!'
        echo '========================================='
    else
        echo ''
        echo '========================================='
        echo 'WARNING: Some jobs may have failed!'
        echo 'Please check the output above for errors.'
        echo '========================================='
        exit 1
    fi
}

if [ "$1" != "" ]; then
    wl=(convert  help)
    for i in "${wl[@]}"
    do
        if [ "$i" == "$1" ]
        then
            $1
            exit 0
        fi
    done
fi

# show some help
help
exit 0
