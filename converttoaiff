#!/bin/bash
set -e

help () {
    cat<<EOF

Usage: converttoaiff [convert|help]

Commands:

    converttoaiff   use bash command to generate audio files from text
                   Now supports parallel background jobs for faster processing!

    Open Terminal.App (for Mac)
    Navigate to the folder where this file is located
    type into the command line "./converttoaiff convert" without quotes
    Enter Password
    Wait...
    help       print this msg

EOF
}

# Detect OS and set TTS command
detect_tts_command() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        TTS_CMD="say"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux
        if command -v spd-say &> /dev/null; then
            TTS_CMD="spd-say -e"
        else
             echo "Error: spd-say not found. Please install speech-dispatcher."
            exit 1
        fi
    else
        echo "Unsupported OS: $OSTYPE"
        exit 1
    fi
    
    echo "Using TTS command: $TTS_CMD"
}

convert () {
    # Detect TTS command at runtime
    detect_tts_command

    # Maximum number of concurrent jobs to prevent resource overload
    # Adjust based on CPU cores - conservative default
    MAX_JOBS=${MAX_JOBS:-4}
    
    echo 'Please be patient! Now using parallel processing for faster conversion!'
    echo "Running up to $MAX_JOBS concurrent jobs..."
    
    # Function to process a single audio file in the background
    process_audio() {
        local pattern="$1"
        local output="$2"
        local label="$3"
        
        echo "Starting $label..."
        cat $pattern | $TTS_CMD -o "$output"
        afconvert -d 'aac ' -f 'mp4f' "$output"
        echo "Completed $label."
    }
    
    # Function to wait for background jobs to stay under limit
    wait_for_job_slot() {
        while [ $(jobs -r | wc -l) -ge $MAX_JOBS ]; do
            sleep 0.5
        done
    }
    
    # Start all conversions as background jobs with controlled parallelism
    wait_for_job_slot
    process_audio "intro_p*.txt" "introduction.aiff" "Introduction" &
    
    wait_for_job_slot
    process_audio "tablet1_p*.txt" "tablet1.aiff" "tablet1" &
    
    wait_for_job_slot
    process_audio "tablet2_p*.txt" "tablet2.aiff" "tablet2" &
    
    wait_for_job_slot
    process_audio "tablet3_p*.txt" "tablet3.aiff" "tablet3" &
    
    wait_for_job_slot
    process_audio "tablet4_p*.txt" "tablet4.aiff" "tablet4" &
    
    wait_for_job_slot
    process_audio "tablet5_p*.txt" "tablet5.aiff" "tablet5" &
    
    wait_for_job_slot
    process_audio "tablet6_p*.txt" "tablet6.aiff" "tablet6" &
    
    wait_for_job_slot
    process_audio "tablet7_p*.txt" "tablet7.aiff" "tablet7" &
    
    wait_for_job_slot
    process_audio "tablet8_p*.txt" "tablet8.aiff" "tablet8" &
    
    wait_for_job_slot
    process_audio "tablet9_p*.txt" "tablet9.aiff" "tablet9" &
    
    wait_for_job_slot
    process_audio "tablet10_p*.txt" "tablet10.aiff" "tablet10" &
    
    wait_for_job_slot
    process_audio "tablet11_p*.txt" "tablet11.aiff" "tablet11" &
    
    wait_for_job_slot
    process_audio "tablet12_p*.txt" "tablet12.aiff" "tablet12" &
    
    wait_for_job_slot
    process_audio "tablet13_p*.txt" "tablet13.aiff" "tablet13" &
    
    wait_for_job_slot
    process_audio "tablet14_p*.txt" "tablet14.aiff" "tablet14" &
    
    wait_for_job_slot
    process_audio "glossary_p*.txt" "glossary.aiff" "glossary" &
    
    # Wait for all background jobs to complete
    echo "Waiting for all conversions to complete..."
    wait
    
    echo "All audio files have been generated successfully!"
}

if [ "$1" != "" ]; then
    wl=(convert  help)
    for i in "${wl[@]}"
    do
        if [ "$i" == "$1" ]
        then
            $1
            exit 0
        fi
    done
fi

# show some help
help
exit 0
